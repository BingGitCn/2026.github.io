<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>个人仪表盘 - 详细天气版 (优化版)</title>
    <style>
        :root {
            /* --- 基础配色 --- */
            --bg-color: #0f172a;
            --text-main: #ffffff;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent-color: #38bdf8;
            --calendar-hover: rgba(56, 189, 248, 0.2);
            --lunar-color: #fbbf24;
            --festival-color: #f472b6;
            
            /* AQI 颜色 */
            --aqi-good: #4ade80;    
            --aqi-moderate: #facc15; 
            --aqi-unhealthy: #f87171; 
            --aqi-hazardous: #a855f7;

            /* --- 字体大小设置 (可在此处调整) --- */
            --font-family: 'Segoe UI', 'PingFang SC', system-ui, sans-serif;
            --font-size-clock: 3.5rem;     /* 时钟大小 */
            --font-size-poetry: 1.15rem;   /* 诗词正文大小 */
            --font-size-title: 1.5rem;     /* 月份标题大小 */
            --font-size-base: 1rem;        /* 基础文字大小 */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* 桌面端隐藏滚动条 */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            font-size: var(--font-size-base);
        }

        /* 动态背景 */
        .ambient-light {
            position: absolute;
            width: 60vw;
            height: 60vw;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.4) 0%, rgba(0, 0, 0, 0) 70%);
            top: -10%;
            left: -10%;
            z-index: -1;
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
        }
        .ambient-light.secondary {
            top: auto;
            bottom: -10%;
            left: auto;
            right: -10%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.3) 0%, rgba(0, 0, 0, 0) 70%);
            animation: float 25s infinite ease-in-out reverse;
        }
        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(30px, 50px); }
            100% { transform: translate(0, 0); }
        }

        /* 布局容器 */
        .container {
            display: flex;
            flex-direction: row;
            width: 90%;
            max-width: 1000px;
            height: 85vh;
            gap: 20px;
            z-index: 1;
        }

        /* 卡片通用样式 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* 左侧面板 */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 320px;
            min-height: 0; /* 防止溢出 */
        }

        .time-section { text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        .clock {
            font-size: var(--font-size-clock);
            font-weight: 700;
            letter-spacing: -2px;
            line-height: 1;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .date-display { font-size: 1.1rem; color: var(--text-secondary); }
        
        .lunar-display {
            margin-top: 15px;
            padding: 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        .lunar-date-main { font-size: 1rem; color: var(--lunar-color); font-weight: 500; }
        .lunar-festival { font-size: 0.9rem; color: var(--festival-color); margin-top: 5px; font-weight: 600; }

        .greeting { font-size: 1.4rem; margin-top: 10px; font-weight: 300; }

        /* 诗词区域 */
        .poetry-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            flex-shrink: 0;
        }
        .poetry-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .poetry-content {
            font-size: var(--font-size-poetry);
            font-style: italic;
            color: var(--text-main);
            line-height: 1.6;
        }
        .poetry-author {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 10px;
            font-style: normal;
        }

        /* 天气区域 */
        .weather-section {
            margin-top: auto; /* 推到底部 */
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        .weather-widget {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .weather-main h3 { font-size: 2.2rem; margin-bottom: 5px; }
        .weather-main p { color: var(--text-secondary); font-size: 0.95rem; }
        .weather-icon { font-size: 2.5rem; }

        /* 详细天气网格 */
        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label { color: var(--text-secondary); font-size: 0.8rem; }
        .detail-value { font-weight: 600; font-size: 1rem; }

        .aqi-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #0f172a;
            font-weight: bold;
        }

        /* 右侧面板 */
        .right-panel { flex: 2; display: flex; flex-direction: column; min-height: 0; }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .month-year { font-size: var(--font-size-title); font-weight: 600; }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .calendar-nav button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-nav button:hover { background: var(--accent-color); }
        .calendar-nav button#todayBtn {
            width: auto;
            padding: 0 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px; /* 稍微减小间距 */
            text-align: center;
        }
        .weekday { color: var(--text-secondary); font-weight: 500; padding-bottom: 10px; font-size: 0.9rem; }

        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            padding: 2px;
            font-size: 0.9rem;
        }
        .day:hover { background: var(--calendar-hover); }
        .day.empty { cursor: default; }
        .day.empty:hover { background: transparent; }
        .day.today {
            background: var(--accent-color);
            color: #0f172a;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
        }

        .day .solar-date { font-size: 1rem; font-weight: 500; line-height: 1.2; }
        .day .lunar-date { font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; line-height: 1; }
        .day.today .lunar-date { color: rgba(15, 23, 42, 0.7); }
        .day.has-festival .lunar-date { color: var(--festival-color); font-weight: 600; }
        .day.lunar-first { color: var(--lunar-color); }
        .day.today.lunar-first { color: #0f172a; font-weight: bold; }

        .icon-svg { width: 48px; height: 48px; fill: currentColor; }
        .tooltip { position: absolute; bottom: 20px; right: 20px; font-size: 0.8rem; color: var(--text-secondary); opacity: 0.6; pointer-events: none;}

        /* --- 响应式设计 (自适应) --- */
        @media (max-width: 900px) {
            .container { width: 95%; height: 95vh; gap: 15px; }
            .clock { font-size: 3rem; }
        }

        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; display: block; padding: 10px 0; }
            
            .container {
                flex-direction: column;
                height: auto;
                width: 95%;
                max-width: 500px; /* 手机上限制最大宽度 */
                padding-bottom: 40px;
            }

            .glass-card {
                padding: 20px; /* 减小内边距 */
            }

            .clock { font-size: 2.5rem; } /* 手机上时钟稍微小一点 */
            .weather-details { grid-template-columns: 1fr 1fr; gap: 8px; }
            
            .day { font-size: 0.8rem; }
            .day .lunar-date { font-size: 0.6rem; }
            
            .calendar-grid { gap: 4px; }
        }
    </style>
</head>
<body>

    <div class="ambient-light"></div>
    <div class="ambient-light secondary"></div>

    <div class="container">
        <aside class="left-panel glass-card">
            <div class="time-section">
                <div class="clock" id="clock">00:00:00</div>
                <div class="date-display" id="fullDate">加载中...</div>
                
                <div class="lunar-display">
                    <div class="lunar-date-main" id="todayLunar">农历计算中...</div>
                    <div class="lunar-festival" id="todayFestival"></div>
                </div>
                
                <div class="greeting" id="greeting">你好</div>
            </div>

            <!-- 诗词区域 -->
            <div class="poetry-section">
                <div class="poetry-title">今日诗词</div>
                <div class="poetry-content" id="poetry-content">加载中...</div>
                <div class="poetry-author" id="poetry-author"></div>
            </div>

            <div class="weather-section">
                <div class="weather-widget">
                    <div class="weather-main">
                        <h3 id="temp">--°</h3>
                        <p id="weather-desc">定位中...</p>
                        <p id="location-text" style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">请允许定位</p>
                    </div>
                    <div class="weather-icon" id="weather-icon">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2v2a10 10 0 0 1 0 20v2a12 12 0 0 0 0-24z"/></svg>
                    </div>
                </div>

                <!-- 详细天气数据网格 -->
                <div class="weather-details">
                    <div class="detail-item">
                        <span class="detail-label">体感温度</span>
                        <span class="detail-value" id="feels-like">--°</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">湿度</span>
                        <span class="detail-value" id="humidity">--%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">风速</span>
                        <span class="detail-value" id="wind">-- km/h</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">风向</span>
                        <span class="detail-value" id="wind-dir">--</span>
                    </div>
                    <!-- 空气质量占满一行 -->
                    <div class="detail-item" style="grid-column: span 2;">
                        <span class="detail-label">空气质量</span>
                        <span class="detail-value" id="aqi">加载中...</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="right-panel glass-card">
            <header class="calendar-header">
                <div class="month-year" id="monthYear">2023年 10月</div>
                <div class="calendar-nav">
                    <button id="prevBtn"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <button id="todayBtn">今天</button>
                    <button id="nextBtn"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                </div>
            </header>
            
            <div class="calendar-grid">
                <div class="weekday">日</div><div class="weekday">一</div><div class="weekday">二</div>
                <div class="weekday">三</div><div class="weekday">四</div><div class="weekday">五</div><div class="weekday">六</div>
            </div>
            <div id="calendarDays" class="calendar-grid" style="margin-top: 5px;"></div>
        </main>
    </div>

    <div class="tooltip">Advanced Weather Version</div>

    <script>
        /**
         * 1. 农历算法 (保持不变)
         */
        const LunarCalendar = (function() {
            const lunarInfo = [
                0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
                0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
                0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
                0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
                0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
                0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,
                0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
                0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,
                0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
                0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,
                0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
                0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,
                0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,
                0x05aa0,0x076a3,0x096d0,0x04afb,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,
                0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,
                0x14b63,0x09370,0x049f8,0x04970,0x064b0,0x168a6,0x0ea50,0x06b20,0x1a6c4,0x0aae0,
                0x0a2e0,0x0d2e3,0x0c960,0x0d557,0x0d4a0,0x0da50,0x05d55,0x056a0,0x0a6d0,0x055d4,
                0x052d0,0x0a9b8,0x0a950,0x0b4a0,0x0b6a6,0x0ad50,0x055a0,0x0aba4,0x0a5b0,0x052b0,
                0x0b273,0x06930,0x07337,0x06aa0,0x0ad50,0x14b55,0x04b60,0x0a570,0x054e4,0x0d160,
                0x0e968,0x0d520,0x0daa0,0x16aa6,0x056d0,0x04ae0,0x0a9d4,0x0a2d0,0x0d150,0x0f252,
                0x0d520
            ];

            const gan = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
            const zhi = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
            const solarMonth = ["正", "二", "三", "四", "五", "六", "七", "八", "九", "十", "冬", "腊"];

            function lYearDays(y) {
                let i, sum = 348;
                for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0;
                return (sum + leapDays(y));
            }

            function leapDays(y) {
                if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29);
                else return (0);
            }

            function leapMonth(y) {
                return (lunarInfo[y - 1900] & 0xf);
            }

            function monthDays(y, m) {
                return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29);
            }

            function toGanZhiYear(lYear) {
                let ganKey = (lYear - 3) % 10;
                let zhiKey = (lYear - 3) % 12;
                if (ganKey === 0) ganKey = 10;
                if (zhiKey === 0) zhiKey = 12;
                return gan[ganKey - 1] + zhi[zhiKey - 1];
            }

            function toChinaMonth(m) { return solarMonth[m - 1]; }

            function toChinaDay(d) {
                switch (d) {
                    case 10: return '初十';
                    case 20: return '二十';
                    case 30: return '三十';
                    default:
                        const tian = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
                        if (d < 10) return '初' + tian[d];
                        if (d < 20) return '十' + tian[d - 10];
                        return '廿' + tian[d - 20];
                }
            }
            
            function getFestival(m, d) {
                const lFestivals = {
                    "1-1": "春节", "1-15": "元宵", "5-5": "端午", "7-7": "七夕", 
                    "7-15": "中元", "8-15": "中秋", "9-9": "重阳", "12-8": "腊八", "12-23": "小年"
                };
                return lFestivals[`${m}-${d}`] || null;
            }

            function solar2lunar(y, m, d) {
                let i, leap = 0, temp = 0;
                let offset = (Date.UTC(y, m - 1, d) - Date.UTC(1900, 0, 31)) / 86400000;
                for (i = 1900; i < 2101 && offset > 0; i++) {
                    temp = lYearDays(i);
                    offset -= temp;
                }
                if (offset < 0) { offset += temp; i--; }
                const year = i;
                leap = leapMonth(i);
                let isLeap = false;
                for (i = 1; i < 13 && offset > 0; i++) {
                    if (leap > 0 && i === (leap + 1) && isLeap === false) {
                        --i; isLeap = true; temp = leapDays(year);
                    } else {
                        temp = monthDays(year, i);
                    }
                    if (isLeap === true && i === (leap + 1)) isLeap = false;
                    offset -= temp;
                }
                if (offset === 0 && leap > 0 && i === leap + 1) {
                    if (isLeap) { isLeap = false; } else { isLeap = true; --i; }
                }
                if (offset < 0) { offset += temp; --i; }

                return {
                    lYear: year,
                    lMonth: i,
                    lDay: offset + 1,
                    yearCn: toGanZhiYear(year),
                    monthCn: (isLeap ? "闰" : "") + toChinaMonth(i),
                    dayCn: toChinaDay(offset + 1),
                    festival: getFestival(i, offset + 1)
                };
            }

            return {
                fromDate: function(date) {
                    return solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
                }
            };
        })();

        /**
         * 2. 获取今日诗词 (修复了 undefined 问题)
         */
        async function fetchDailyPoetry() {
            try {
                const response = await fetch('https://v2.jinrishici.com/one.json');
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    // 修复：优先从 data.origin 中获取标题和作者，如果不存在则从 data 获取，最后回退到默认值
                    const content = data.data.content || "暂无内容";
                    const origin = data.data.origin || {};
                    const author = origin.author || data.data.author || "佚名";
                    const title = origin.title || data.data.title || "无题";

                    document.getElementById('poetry-content').textContent = content;
                    document.getElementById('poetry-author').textContent = `—— ${author}《${title}》`;
                } else {
                    throw new Error("API status not success");
                }
            } catch (error) {
                console.error("获取诗词失败:", error);
                // 如果API失败，使用备用诗词
                const backupPoetry = [
                    { content: "春眠不觉晓，处处闻啼鸟。", author: "孟浩然", title: "春晓" },
                    { content: "床前明月光，疑是地上霜。", author: "李白", title: "静夜思" },
                    { content: "白日依山尽，黄河入海流。", author: "王之涣", title: "登鹳雀楼" }
                ];
                const randomPoetry = backupPoetry[Math.floor(Math.random() * backupPoetry.length)];
                document.getElementById('poetry-content').textContent = randomPoetry.content;
                document.getElementById('poetry-author').textContent = `—— ${randomPoetry.author}《${randomPoetry.title}》`;
            }
        }

        /**
         * 3. 时间与日期逻辑
         */
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('fullDate').textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            const lunarData = LunarCalendar.fromDate(now);
            document.getElementById('todayLunar').textContent = `农历${lunarData.yearCn}年 ${lunarData.monthCn}${lunarData.dayCn}`;
            document.getElementById('todayFestival').textContent = lunarData.festival || "";
            
            const hour = now.getHours();
            const greetings = { [0]: '夜深了', [6]: '早上好', [11]: '中午好', [13]: '下午好', [18]: '晚上好' };
            document.getElementById('greeting').textContent = greetings[[...Object.keys(greetings), 24].reverse().find(k => hour >= k) || 0];
        }
        setInterval(updateClock, 1000);
        updateClock();

        /**
         * 4. 详细天气逻辑
         */
        const weatherIcons = {
            '晴': `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"></path></svg>`,
            '多云': `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M19.36 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.64-4.96z"/></svg>`,
            '阴': `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`,
            '雨': `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M4.11 11.23C4.69 8.09 7.43 6 10.72 6c3.09 0 5.7 1.96 6.55 4.66.15-.01.3-.03.45-.03 2.48 0 4.5 2.02 4.5 4.5s-2.02 4.5-4.5 4.5H5.28c-2.21 0-4-1.79-4-4 0-2.05 1.53-3.76 3.56-3.97l.27-.03z"/></svg>`,
            '雷阵雨': `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M4.11 11.23C4.69 8.09 7.43 6 10.72 6c3.09 0 5.7 1.96 6.55 4.66.15-.01.3-.03.45-.03 2.48 0 4.5 2.02 4.5 4.5s-2.02 4.5-4.5 4.5H5.28c-2.21 0-4-1.79-4-4 0-2.05 1.53-3.76 3.56-3.97l.27-.03zM11 21l-2-3h2l-2-3h2l-2-3h3l2 3h-2l2 3h-2l2 3h-3z"/></svg>`
        };

        function getWeatherDesc(code) {
            if (code === 0) return '晴';
            if (code <= 3) return '多云';
            if (code <= 48) return '雾';
            if (code <= 67) return '雨';
            if (code <= 77) return '雪';
            if (code <= 82) return '阵雨';
            return '雷阵雨';
        }

        function getWindDir(deg) {
            const dirs = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
            return dirs[Math.round(deg / 45) % 8];
        }

        function getAqiInfo(aqi) {
            let color = 'var(--aqi-good)';
            let text = '优';
            if (aqi > 50) { color = 'var(--aqi-moderate)'; text = '良'; }
            if (aqi > 100) { color = 'var(--aqi-unhealthy)'; text = '轻度污染'; }
            if (aqi > 150) { color = 'var(--aqi-hazardous)'; text = '中度污染'; }
            if (aqi > 200) { text = '重度污染'; }
            return { color, text, value: aqi };
        }

        async function fetchLocationName(lat, lon) {
            try {
                const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                let location = data.city || data.locality || data.principalSubdivision;
                if (data.city && data.locality && data.city !== data.locality) location = `${data.city} ${data.locality}`;
                document.getElementById('location-text').textContent = location || "未知位置";
            } catch (e) {
                document.getElementById('location-text').textContent = `(${lat.toFixed(2)}, ${lon.toFixed(2)})`;
            }
        }

        function initWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchRealWeather(latitude, longitude);
                        fetchAirQuality(latitude, longitude);
                        fetchLocationName(latitude, longitude);
                    },
                    (error) => {
                        console.error("定位失败", error);
                        document.getElementById('location-text').textContent = "北京 (默认)";
                        fetchRealWeather(39.9042, 116.4074);
                        fetchAirQuality(39.9042, 116.4074);
                    }
                );
            }
        }

        async function fetchRealWeather(lat, lon) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m&timezone=auto`;
                const response = await fetch(url);
                const data = await response.json();
                const current = data.current;

                document.getElementById('temp').textContent = `${Math.round(current.temperature_2m)}°`;
                document.getElementById('weather-desc').textContent = getWeatherDesc(current.weather_code);
                document.getElementById('weather-icon').innerHTML = weatherIcons[getWeatherDesc(current.weather_code)] || weatherIcons['晴'];
                
                document.getElementById('feels-like').textContent = `${Math.round(current.apparent_temperature)}°`;
                document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
                document.getElementById('wind').textContent = `${current.wind_speed_10m} km/h`;
                document.getElementById('wind-dir').textContent = getWindDir(current.wind_direction_10m);
            } catch (error) {
                console.error("天气获取失败:", error);
            }
        }

        async function fetchAirQuality(lat, lon) {
            try {
                // 修复：同时请求 cn_aqi 和 us_aqi，如果 cn_aqi 无效则使用 us_aqi
                const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=cn_aqi,us_aqi`;
                const response = await fetch(url);
                const data = await response.json();
                
                // 优先使用中国标准，否则使用美国标准
                let aqi = data.current.cn_aqi;
                let aqiType = "CN AQI";
                
                if (!aqi && data.current.us_aqi) {
                    aqi = data.current.us_aqi;
                    aqiType = "US AQI";
                }

                if (aqi) {
                    const info = getAqiInfo(aqi);
                    const aqiEl = document.getElementById('aqi');
                    aqiEl.innerHTML = `${info.value} <span class="aqi-badge" style="background-color:${info.color}">${info.text} (${aqiType})</span>`;
                } else {
                    throw new Error("No AQI data");
                }
            } catch (error) {
                console.error("AQI获取失败:", error);
                document.getElementById('aqi').textContent = "无数据";
            }
        }

        initWeather();

        /**
         * 5. 日历逻辑
         */
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const calendarDays = document.getElementById('calendarDays');

        function renderCalendar(month, year) {
            calendarDays.innerHTML = "";
            document.getElementById('monthYear').textContent = `${year}年 ${month + 1}月`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

            for (let i = 0; i < firstDay; i++) {
                const d = document.createElement('div');
                d.className = 'day empty';
                calendarDays.appendChild(d);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const d = document.createElement('div');
                d.className = 'day';
                
                const s = document.createElement('span');
                s.className = 'solar-date';
                s.textContent = day;
                d.appendChild(s);

                const l = document.createElement('span');
                l.className = 'lunar-date';
                const lunarData = LunarCalendar.fromDate(new Date(year, month, day));
                
                if (lunarData.festival) {
                    l.textContent = lunarData.festival;
                    d.classList.add('has-festival');
                } else if (lunarData.lDay === 1) {
                    l.textContent = lunarData.monthCn + '月';
                    d.classList.add('lunar-first');
                } else {
                    l.textContent = lunarData.dayCn;
                }
                d.appendChild(l);

                if (isCurrentMonth && day === today.getDate()) d.classList.add('today');
                
                d.onclick = function() {
                    document.querySelectorAll('.day').forEach(el => el.style.border = 'none');
                    if(!this.classList.contains('today')) this.style.border = '1px solid var(--accent-color)';
                };
                calendarDays.appendChild(d);
            }
        }

        renderCalendar(currentMonth, currentYear);

        document.getElementById('prevBtn').onclick = () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar(currentMonth, currentYear);
        };
        document.getElementById('nextBtn').onclick = () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar(currentMonth, currentYear);
        };
        document.getElementById('todayBtn').onclick = () => {
            const now = new Date();
            currentMonth = now.getMonth();
            currentYear = now.getFullYear();
            renderCalendar(currentMonth, currentYear);
        };

        // 页面加载完成后获取诗词
        fetchDailyPoetry();
    </script>
</body>
</html>
